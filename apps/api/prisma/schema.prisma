generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  DISPATCHER
  COURIER
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  IN_TRANSIT
  DELIVERED
  FAILED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model User {
  id           String    @id @default(uuid())
  email        String?   @unique
  username     String?   @unique
  pin          String?
  passwordHash String?
  fullName     String
  phone        String?
  role         Role      @default(COURIER)
  isActive     Boolean   @default(true)
  fcmToken     String?

  deliveries Delivery[]
  locations  CourierLocation[]
  routePoints DeliveryRoutePoint[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Customer {
  id        String   @id @default(uuid())
  name      String
  phone     String
  email     String?
  address   String
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)
  notes     String?

  deliveries Delivery[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customers")
}

model Delivery {
  id           String         @id @default(uuid())
  trackingCode String         @unique @default(cuid())
  customerId   String
  customer     Customer       @relation(fields: [customerId], references: [id])
  courierId    String?
  courier      User?          @relation(fields: [courierId], references: [id])
  status       DeliveryStatus @default(PENDING)
  priority     Priority       @default(NORMAL)

  description    String?
  packageDetails String?
  scheduledDate  DateTime?

  photoUrl      String?
  signatureUrl  String?
  videoUrl      String?
  deliveryLat   Decimal? @db.Decimal(10, 8)
  deliveryLng   Decimal? @db.Decimal(11, 8)
  deliveredAt   DateTime?
  deliveryNotes String?
  rating        Int?

  localId  String?
  syncedAt DateTime?

  photos      DeliveryPhoto[]
  routePoints DeliveryRoutePoint[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courierId, status])
  @@index([scheduledDate])
  @@index([trackingCode])
  @@map("deliveries")
}

model DeliveryPhoto {
  id         String   @id @default(uuid())
  deliveryId String
  delivery   Delivery @relation(fields: [deliveryId], references: [id])
  url        String
  publicId   String?
  width      Int?
  height     Int?
  bytes      Int?

  createdAt DateTime @default(now())

  @@index([deliveryId])
  @@map("delivery_photos")
}

model DeliveryRoutePoint {
  id           String   @id @default(uuid())
  deliveryId   String
  delivery     Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  courierId    String
  courier      User     @relation(fields: [courierId], references: [id], onDelete: Restrict)
  latitude     Decimal  @db.Decimal(10, 8)
  longitude    Decimal  @db.Decimal(11, 8)
  accuracy     Decimal? @db.Decimal(5, 2)
  speed        Decimal? @db.Decimal(5, 2)
  batteryLevel Int?
  recordedAt   DateTime @default(now())

  @@index([deliveryId, recordedAt(sort: Asc)])
  @@index([courierId, recordedAt(sort: Desc)])
  @@map("delivery_route_points")
}

model CourierLocation {
  id           String   @id @default(uuid())
  courierId    String
  courier      User     @relation(fields: [courierId], references: [id])
  latitude     Decimal  @db.Decimal(10, 8)
  longitude    Decimal  @db.Decimal(11, 8)
  accuracy     Decimal? @db.Decimal(5, 2)
  speed        Decimal? @db.Decimal(5, 2)
  batteryLevel Int?

  recordedAt DateTime @default(now())

  @@index([courierId, recordedAt(sort: Desc)])
  @@map("courier_locations")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("refresh_tokens")
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
}

model AppLog {
  id        String   @id @default(uuid())
  level     LogLevel @default(ERROR)
  message   String
  stack     String?
  context   Json?
  userId    String?
  deviceInfo Json?
  platform  String?
  appVersion String?

  createdAt DateTime @default(now())

  @@index([level])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("app_logs")
}
